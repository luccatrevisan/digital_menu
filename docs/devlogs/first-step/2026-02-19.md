## 19/02/2026 e 21/02/2026 - Feature de disponibilidade por quantidade do estoque

### Objetivo
Na última tarefa (devlog 2026-02-18.md) aprendi bastante sobre as funções clean() e save() dos models do Django para adicionar a feature de preço promocional. Pensei em seguir uma estrutura parecida para fazer uma validação de disponibilidade para o estoque. Mas o desafio era maior do que eu esperava por ter que lidar com dois models diferentes: Stock e MenuItem.

### O que implementei
- Model Stock
```python
    class Stock(models.Model):
        quantity = models.IntegerField(null=True, blank=True, validators=[MinValueValidator(0)]) # adicionei validação de valor mínimo e aceito valores nulos

        def __str__(self):
            return f"{self.quantity}" #tinha escrevido errado, com f DEPOIS das aspas. percebi quando tava dando erro no admin
```
- Signal post_save
```python
    @receiver(post_save, sender="menu.Stock", dispatch_uid="menu_stock_post_save_availability") # dispatch_uid para evitar duplicações
    def menu_item_availability(sender, instance, **kwargs):
        if instance.quantity is None or instance.quantity > 0:
            instance.menu_item.is_available = True
        else:
            instance.menu_item.is_available = False
        instance.menu_item.save(update_fields=["is_available"]) # é preciso salvar as informações, não só mudar o valor do atributo
```
- Signal post_delete
```python
    @receiver(post_delete, sender="menu.Stock", dispatch_uid="menu_stock_post_delete_availability")
    def handle_deleted_stock(sender, instance, **kwargs):
        instance.menu_item.is_available = True
        instance.menu_item.save(update_fields=["is_available"])
```
- AppConfig
```python
    class MenuConfig(AppConfig):
        name = 'menu'

        def ready(self): # built-in function do django para inicialização do app
            import menu.signals
```
- Admin
```python
    list_display = ["id", "image", "name", "category", "old_price", "price", "is_available"] # adicionei is_available para facilitar os testes
```

### Decisões
- **Por que permiti valores nulos e blank na quantidade do estoque:**
    Por questões de práticas que considero comuns no mercado. Atualmente, utilizo 3 sistemas de cardápio online/delivery: iFood, 99Food e Cardápio Web. Como a 99 ainda está bem recente, começando as atividades em outubro de 2025 - se não me engano - eles ainda não têm certas funcionalidades como de estoque. Não consigo gerenciar quantidades no portal deles. Porém, nos outros dois serviços, qualquer loja tem a possibilidade de não colocar uma quantidade de estoque e o produto está sempre disponível - a não ser que a loja simplesmente marque como indisponível diretamente em um botão. Essa já é a primeira regra de negócio: se o estoque estiver em branco, considere o produto sempre disponível. A segunda já é mais intuitiva: se o estoque tiver uma quantidade maior que 0, ele está disponível.

    OBS.: inicialmente, achava que utilizar o MinValueValidator(0) poderia causar algum erro por conflitar com null=True e blank=True. Porém, aprendi que esse validador funciona somente se eu tivesse uma quantidade especificada, sem causar conflitos. É uma informação mais boba, mas acho que vale registrar.

- **Por que utilizar signals e não clean() ou save():**
    Optei por inserir a lógica de disponibilidade que expliquei acima dentro do signal porque ela utiliza dois models diferentes. Se eu crio dentro do model utilizando as funções clean() e save(), eu só conseguiria fazer a lógica ao criar - e salvar - um estoque. Caso eu deletasse o estoque, ele deveria considerar que o produto ainda está disponível, apesar de não ter uma quantidade definida (regra de negócio). Essa regra não seria atendida sem o uso de signals.

### Desafios
1. Não sabia nada sobre signals.
   - **Como resolvi:** Li a documentação mas tive que pesquisar alguns vídeos no youtube para me aprofundar. Gosto de uma abordagem mais simplificada, explicada, do que a abordagem mais técnica da documentação para aprender conceitos que não vi antes.
   - **O que aprendi:** Inicialmente, eu ia montar essa lógica de disponibilidade utilizando o método save() porém, ao organizar as tarefas do dia, os signals foram recomendados por um chatbot de IA. Como não sabia o que era, fui atrás de informações e vi como esse conceito vai ser muito importante daqui pra frente. Na etapa 5 do projeto, por exemplo, pretendo implementar um sistema de notificações usando Twilio - provavelmente - e signals podem ser muito úteis ao identificar quando um pedido estiver passando pelo funil de vendas. Ao pagamento ser concluído, por exemplo, posso gerar um signal para que a notificação de confirmação seja enviada ou, em outra ocasião, um signal para lembrar o cliente de concluir o pagamento. 

   No final das contas, preferi utilizar para já me acostumar com eles mas isso não significa que eu não reconheça os benefícios técnicos de utilizar os signals. Eles mantém o código mais limpo, cobrem mais situações, como save E delete, no meu caso, e pode causar loops. Nesse projeto em específico, não causaria loops - pelo menos ainda - porque os dois models MenuItem e Stock, ao serem salvos, poderiam trocar informações relacionadas entre si.

### Referências
- https://www.youtube.com/watch?v=rEX50LJrFuU&list=PL0efIqwJO9kDGQ34csSYNSm2udR4kOrdb
- https://www.youtube.com/watch?v=T6PyDm79PFo&t=1120s
- https://docs.djangoproject.com/en/6.0/topics/signals/
- https://docs.djangoproject.com/en/6.0/topics/signals/#defining-and-sending-signals
- https://docs.djangoproject.com/en/6.0/ref/models/instances/#saving-objects
- https://docs.djangoproject.com/en/6.0/ref/applications/#django.apps.AppConfig.ready
- https://docs.djangoproject.com/en/6.0/topics/signals/#django.dispatch.receiver
- https://docs.djangoproject.com/en/6.0/topics/signals/#connecting-to-signals-sent-by-specific-senders
- https://docs.djangoproject.com/en/6.0/topics/signals/#preventing-duplicate-signals
        "The ready() method may be executed more than once during testing, so you may want to guard your signals from duplication, especially if you’re planning to send them within tests."

### Próximos passos
- [ ] Como fazer com que um pedido faça a quantidade do estoque diminuir? -> Situação futura para quando eu estiver implementando features de pedido e carrinho
- [ ] Serializer aninhado com Stock

---